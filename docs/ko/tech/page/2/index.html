<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  
  <title>sixmen.com: Tech</title>
  
  
  <meta name='author' content='Sangmin Yoon'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>

  <!--[if lt IE 9]>
  <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
  <script src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js'></script>
  <![endif]-->
</head>

<body>
<div class='hp-navbar'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-xs-12'>
        
        <nav class='hp-nav'>
          <a class='hp-nav-item'
            href='/ko/'>Home</a>
          <a class='hp-nav-item'
            href='/ko/mylife/'>MyLife</a>
          <a class='hp-nav-item'
            href='/ko/travel/'>Travel</a>
          <a class='hp-nav-item active'
            href='/ko/tech/'>Tech</a>
          <a class='hp-nav-item'
            href='/ko/tags/'>Tags</a>
          <a class='hp-nav-item pull-right' href='/en/'>English</a>
        </nav>
      </div>
    </div>
  </div>
</div>



<div class='container'>

  <div class='row' style='margin-top: 20px;'>

    <div class='col-sm-10 col-sm-offset-1'>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2019-04-28-1-croquis-stack-thrift/'>크로키의 스택 - Thrift</a></h2>
          <p class='posts-date'>28 Apr 2019</p>
        </div>
        <div class='panel-body'>
          <p>2016년 중반 마이크로서비스로의 전환을 결정했습니다.
마이크로서비스는 이론상 다른 서비스에 영향을 주지 않고 내부 기술을 바꿀 수 있습니다.
하지만 마이크로서비스 간의 통신 방법은 한번 결정하면 쉽게 바뀌기 어려울 것 같아서 가장 많이 고민했습니다.
그리고 Thrift를 선택했습니다.
이번 글에서는 그 이유와 이후의 상황에 관해 설명하겠습니다.</p>

<p>마이크로서비스에 대한 글들을 찾아보면 대부분은 통신 방법도 REST API를 많이 얘기하고 있습니다.
(예. <a href="https://www.nginx.com/blog/introduction-to-microservices/">Introduction to Microservices | NGINX</a>)
그러나 <a href='/ko/tech/2018-05-30-1-croquis-stack-rest-api/'>이전 글</a>에서
썼듯이 REST API에 불편함을 느끼고 있었습니다. 특히 마이크로서비스 간에는 REST로 표현하기 어려운 더 다양한 API가 필요해질 것 같았습니다.
그래서 대안을 찾아봤습니다.</p>

<p>그 당시 고려했던 대안은 <a href="https://thrift.apache.org/">Thrift</a>, <a href="https://avro.apache.org/">Avro</a>, <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>였던 것으로 기억합니다.
지금 시점에 괜찮아 보이는 <a href="https://grpc.io/">gRPC</a>는 이상하게 당시 고려대상에서 벗어나 있었던 것 같습니다.
아마 RPC 보다는 데이터 직렬화 쪽을 더 중점적으로 생각했던 것 같습니다.
데이터- 특히 배열 -를 JSON으로 만들면 크기가 매우 크기 때문에 데이터 크기가 줄어드는 게 매력적으로 다가왔습니다.</p>

<p>그중에서 Thrift를 선택한 건 다음과 같은 이유가 있었던 것 같습니다.</p>

<ol>
<li>Avro 방식보다는 Thrift / Protocol Buffers 방식이 더 작은 사이즈를 만들 것 같았습니다.</li>
<li>Protocol Buffers는 JavaScript를 잘 지원하는 듯이 보이지 않았습니다. (공식 문서의 튜토리얼에 없음)</li>
<li>VCNC에서 Thrift를 쓰고 있다는 글을 봐서 어느 정도 검증이 됐으리라 봤습니다.</li>
</ol>

<p>그렇게 Thrift를 마이크로서비스 간의 통신에 적용하는 작업을 시작했는데 생각만큼 잘 동작하지는 않았습니다.</p>

<ol>
<li>JavaScript를 지원하지만, 막상 해보니 클리어언트 JavaScript 용이었고, Node.js에 어울리는 코드를 만들어주지 않았습니다. TypeScript 지원을 포함해 몇 가지 수정을 가해서 사용하고 있습니다. (<a href="https://github.com/croquiscom/thrift/tree/croquis-171130">https://github.com/croquiscom/thrift/tree/croquis-171130</a>)</li>
<li>TCP 소켓 통신을 통해 요청마다 연결을 만들어야 하는 낭비를 없애기를 기대했는데, 오토 스케일링과 어울리지 않아서 결국 HTTP 통신을 했습니다.</li>
</ol>

<p>몇 가지 문제가 있긴 하지만, 오랜 시간에 걸쳐 안정화되어 현재 수백개의 Thrift API가 존재하고 있습니다.</p>

<p>크로키닷컴만의 특이한 규칙이 하나 있다면 Read API에서 모든 필드 요청을 피하기 위해서 받기를 원하는 필드를 지정할 수 있도록 구성되어 있다는 것입니다.
Update API도 하나로 여러 요구 사항에 대응하기 위해 업데이트를 할 필드를 같이 주도록 했습니다.</p>

<div class="highlight"><pre class="chroma"><code class="language-thrift" data-lang="thrift"><span class="c">/// 지그재그 공지사항
</span><span class="c"></span><span class="kd">struct</span><span class="w"> </span><span class="nc">ZigzagNotice</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="c">/// 레코드 ID
</span><span class="c"></span><span class="w">  </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">id</span><span class="w">
</span><span class="w">  </span><span class="c">/// 공지사항 내용
</span><span class="c"></span><span class="w">  </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">contents</span><span class="w">
</span><span class="w">  </span><span class="c">/// 공지 날짜
</span><span class="c"></span><span class="w">  </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">date</span><span class="w">
</span><span class="w">  </span><span class="c">/// 배포 대상 OS 타입 (0:common,1:none,2:iOS,3:Android)
</span><span class="c"></span><span class="w">  </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">os</span><span class="w">
</span><span class="w">  </span><span class="c">/// 공지사항에 필요한 링크 URL
</span><span class="c"></span><span class="w">  </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">link</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="kd">service</span><span class="w"> </span><span class="nc">ZigzagNoticeService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="cm">/**
</span><span class="cm">   * 해당 레코드 ID의 공지사항을 반환한다.
</span><span class="cm">   *
</span><span class="cm">   * fields는 ZigzagNotice의 구조체 필드 ID로 빈 경우 레코드 ID만 반환한다.
</span><span class="cm">   */</span><span class="w">
</span><span class="w">  </span><span class="n">ZigzagNotice</span><span class="w"> </span><span class="nf">getZigzagNotice</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">notice_id</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="kt">list</span><span class="p">&lt;</span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="cm">/**
</span><span class="cm">   * 해당 레코드 ID의 공지사항을 업데이트 한다.
</span><span class="cm">   *
</span><span class="cm">   * fields는 ZigzagNotice의 구조체 필드 ID로 정의된 필드의 값만 업데이트 된다.
</span><span class="cm">   */</span><span class="w">
</span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateZigzagNotice</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">notice_id</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">ZigzagNotice</span><span class="w"> </span><span class="n">notice</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="kt">list</span><span class="p">&lt;</span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span></code></pre></div>

<p>이렇게 1년 이상 Thrift를 사용해왔지만 여러 가지 불편함이 발생했습니다.</p>

<ol>
<li>라이브러리가 활발하게 개발되지 않고 있습니다. 특히 JavaScript/Node.js 쪽은 큰 변화가 없습니다.</li>
<li>TypeScript와 잘 어울리지 않았습니다.</li>
<li>API 추가/변경 시마다 코드를 생성해야 하는 것이 생각보다 불편했습니다.</li>
</ol>

<p>그래서 2017년 말에 GraphQL을 살펴보기 시작해서 현재는 새로 작성하는 모든 API를 GraphQL로 만들고 있습니다.
다음번에는 크로키닷컴에서 GraphQL을 적용하는 과정에 관해서 설명하겠습니다.</p>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2019-04-27-1-make-slack-bot-using-botkit/'>BotKit을 이용한 슬랙 봇 만들기</a></h2>
          <p class='posts-date'>27 Apr 2019</p>
        </div>
        <div class='panel-body'>
          

<p>크로키닷컴을 시작하고 비교적 초기부터 ChatOps를 해보고 싶었습니다.
GitHub의 글을 보고 도입하고 싶다는 생각이 들었던 거로 기억합니다.
당연하게 <a href="https://hubot.github.com/">Hubot</a>을 이용해 채팅봇을 설정했습니다.</p>

<p>초기에는 HipChat에 Hubot을 붙였고, 2014년 중반 Slack으로 전환했습니다.
봇을 활용하려는 시도는 여러 번 했지만 대부분 장난 수준을 벗어나지 못했고(예. 점심 메뉴 보여주고 임의로 고르기),
그나마 조금 복잡했던 것이 Box, Dropbox, Evernote에서 변경된 내용을 인식해 특정 채널에 알려주는 기능이었습니다.</p>

<p>그렇게 방치하다가 2019년에 들어와 개발팀 인원도 늘어나서 다시 한번 제대로 채팅봇을 만들자는 얘기가 나왔습니다.
이전에 작업해서 익숙한 Hubot을 다시 사용할까 했는데 아무래도 소스 기반이 CoffeeScript인게 마음에 걸렸습니다.
여러 가지를 찾아보다가 <a href="https://botkit.ai/">Botkit</a>을 사용하기로 결정했습니다.</p>

<p>이번 글에서는 Botkit을 이용해 슬랙 봇을 만드는 방법을 설명합니다.</p>

<h1 id="슬랙-앱-생성">슬랙 앱 생성</h1>

<p>Hubot은 <a href="https://slack.com/apps/A0F7XDU93-hubot">슬랙 앱</a>이 있어서 설정이 편했는데,
Botkit은 슬랙 앱을 만들어야 합니다.</p>

<p>Botkit은 AI 봇을 만들어 여러 업체에 제공하기 위한 솔루션인 듯 여러 팀을 다룰 수 있도록 구성되어 있고,
<a href="https://botkit.ai/docs/provisioning/slack-events-api.html">Botkit 슬랙 앱 설정 문서</a>도
내용이 많습니다. 하지만 내부적으로 사용하는 용도로는 그렇게까지 필요하지 않습니다.</p>

<p>우선 <a href="https://api.slack.com/apps">Your Apps</a>에 가서 새 앱 생성을 합니다.</p>

<p><img src="/img/ko/tech/2019-04-27-1-01.png" alt="Create a Slack App" /></p>

<p>그리고 Bot Users 메뉴에서 Bot User를 추가합니다.</p>

<p><img src="/img/ko/tech/2019-04-27-1-02.png" alt="Add Bot User" /></p>

<p>마지막으로 Install App에서 'Install App to Workspace'를 누르고 Authorize를 선택하면 Bot User Access Token을 얻을 수 있습니다.</p>

<p><img src="/img/ko/tech/2019-04-27-1-03.png" alt="Installed App Settings" /></p>

<h1 id="bot-만들기">Bot 만들기</h1>

<p><a href="https://github.com/howdyai/botkit-starter-slack">Botkit Starter Kit for Slack Bots</a>가 있지만,
이 역시 저희 용도에는 너무 복잡해서 처음부터 만들기로 했습니다.</p>

<p>필요한 패키지는 <a href="https://www.npmjs.com/package/botkit">botkit</a>, <a href="https://www.npmjs.com/package/dotenv">dotenv</a> 뿐입니다.
그리고 TypeScript로 만들기 위해 typescript와 ts-node를 추가합니다.</p>

<p><strong><em>package.json</em></strong>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;bot&#34;</span><span class="p">,</span>
  <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;ts-node app.ts&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;botkit&#34;</span><span class="p">:</span> <span class="s2">&#34;^0.7.4&#34;</span><span class="p">,</span>
    <span class="nt">&#34;dotenv&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.0.0&#34;</span><span class="p">,</span>
    <span class="nt">&#34;ts-node&#34;</span><span class="p">:</span> <span class="s2">&#34;^8.0.3&#34;</span><span class="p">,</span>
    <span class="nt">&#34;typescript&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.4.3&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;devDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;@types/dotenv&#34;</span><span class="p">:</span> <span class="s2">&#34;^6.1.1&#34;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div></p>

<p>Access Token은 소스 관리가 되지 않는 .env 파일에 기록합니다.</p>

<p><strong><em>.env</em></strong>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">SLACK_BOT_TOKEN</span><span class="o">=</span>xoxb-276777......</code></pre></div></p>

<p>TypeScript 컴파일 설정도 만들어줍니다.</p>

<p><strong><em>tsconfig.json</em></strong>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;compilerOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;noImplicitAny&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&#34;noImplicitThis&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&#34;strictNullChecks&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&#34;target&#34;</span><span class="p">:</span> <span class="s2">&#34;es2017&#34;</span><span class="p">,</span>
    <span class="nt">&#34;module&#34;</span><span class="p">:</span> <span class="s2">&#34;CommonJS&#34;</span><span class="p">,</span>
    <span class="nt">&#34;moduleResolution&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
    <span class="nt">&#34;esModuleInterop&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&#34;lib&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&#34;es2017&#34;</span><span class="p">,</span>
      <span class="s2">&#34;dom&#34;</span><span class="p">,</span>
      <span class="s2">&#34;esnext.asynciterable&#34;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div></p>

<p>마지막으로 다음과 같이 봇 코드를 작성합니다.</p>

<p><strong><em>app.ts</em></strong>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="nx">Botkit</span> <span class="nx">from</span> <span class="s1">&#39;botkit&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">dotenv</span> <span class="nx">from</span> <span class="s1">&#39;dotenv&#39;</span><span class="p">;</span>

<span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">controller</span> <span class="o">=</span> <span class="nx">Botkit</span><span class="p">.</span><span class="nx">slackbot</span><span class="p">({</span>
<span class="p">});</span>

<span class="nx">controller</span><span class="p">.</span><span class="nx">startTicking</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({</span> <span class="nx">token</span>: <span class="kt">process.env.SLACK_BOT_TOKEN</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span> <span class="p">});</span>

<span class="nx">bot</span><span class="p">.</span><span class="nx">startRTM</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;구동에 실패했습니다.&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">bot</span><span class="p">.</span><span class="nx">say</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;봇이 배포되었습니다! 😄&#39;</span><span class="p">,</span> <span class="nx">channel</span><span class="o">:</span> <span class="s1">&#39;Cxxxxx&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div></p>

<p><code>npm start</code>를 하면 봇이 구동되고 지정한 채널에 메시지가 표시됩니다.</p>

<h1 id="봇-스킬-추가">봇 스킬 추가</h1>

<p>봇 동작을 기술할 스크립트는 Botkit Starter Kit에 맞춰 스킬이라고 부르기로 했습니다.</p>

<p>스킬 추가는 파일을 추가하기만 하면 되는 구조로 작성했습니다.</p>

<p><strong><em>skill/index.ts</em></strong>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">SlackController</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;botkit&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s1">&#39;fs&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">loadSkills</span> <span class="o">=</span> <span class="p">(</span><span class="nx">controller</span>: <span class="kt">SlackController</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span> <span class="o">!==</span> <span class="s1">&#39;index.ts&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">filename</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;.disabled.&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">).</span><span class="k">default</span><span class="p">(</span><span class="nx">controller</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></code></pre></div></p>

<p><strong><em>app.ts</em></strong>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="p">...</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">loadSkills</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./skill&#39;</span><span class="p">;</span>

<span class="p">...</span>

<span class="nx">loadSkills</span><span class="p">(</span><span class="nx">controller</span><span class="p">);</span></code></pre></div></p>

<p>다음은 Botkit Starter Kit for Slack Bots에서 가져온 스킬 샘플입니다.
봇에게 color나 question이라는 단어를 포함해 1:1 메시지(direct_message)를 보내거나 언급하면 동작합니다.</p>

<p><strong><em>skill/sample-conversation.ts</em></strong>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// copied from https://github.com/howdyai/botkit-starter-slack/blob/master/skills/sample_conversations.js
</span><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">SlackController</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;botkit&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="p">(</span><span class="nx">controller</span>: <span class="kt">SlackController</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">controller</span><span class="p">.</span><span class="nx">hears</span><span class="p">([</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;direct_message&#39;</span><span class="p">,</span> <span class="s1">&#39;direct_mention&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">bot</span><span class="p">.</span><span class="nx">startConversation</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">convo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">convo</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;This is an example of using convo.ask with a single callback.&#39;</span><span class="p">);</span>
      <span class="nx">convo</span><span class="p">.</span><span class="nx">ask</span><span class="p">(</span><span class="s1">&#39;What is your favorite color?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">convo</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;Cool, I like &#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span> <span class="o">+</span> <span class="s1">&#39; too!&#39;</span><span class="p">);</span>
        <span class="nx">convo</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">controller</span><span class="p">.</span><span class="nx">hears</span><span class="p">([</span><span class="s1">&#39;question&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;direct_message&#39;</span><span class="p">,</span> <span class="s1">&#39;direct_mention&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">bot</span><span class="p">.</span><span class="nx">createConversation</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">convo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">convo</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;How wonderful.&#39;</span> <span class="p">},</span> <span class="s1">&#39;yes_thread&#39;</span><span class="p">);</span>
      <span class="nx">convo</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Cheese! It is not for everyone.&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;stop&#39;</span> <span class="p">},</span> <span class="s1">&#39;no_thread&#39;</span><span class="p">);</span>
      <span class="nx">convo</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Sorry I did not understand. Say `yes` or `no`&#39;</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;default&#39;</span> <span class="p">},</span> <span class="s1">&#39;bad_response&#39;</span><span class="p">);</span>

      <span class="nx">convo</span><span class="p">.</span><span class="nx">ask</span><span class="p">(</span><span class="s1">&#39;Do you like cheese?&#39;</span><span class="p">,</span> <span class="p">[{</span>
        <span class="nx">pattern</span>: <span class="kt">bot.utterances.yes</span><span class="p">,</span>
        <span class="nx">callback</span><span class="o">:</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">convo</span><span class="p">.</span><span class="nx">gotoThread</span><span class="p">(</span><span class="s1">&#39;yes_thread&#39;</span><span class="p">);</span>
        <span class="p">},</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="nx">pattern</span>: <span class="kt">bot.utterances.no</span><span class="p">,</span>
        <span class="nx">callback</span><span class="o">:</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">convo</span><span class="p">.</span><span class="nx">gotoThread</span><span class="p">(</span><span class="s1">&#39;no_thread&#39;</span><span class="p">);</span>
        <span class="p">},</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="k">default</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">callback</span><span class="o">:</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">convo</span><span class="p">.</span><span class="nx">gotoThread</span><span class="p">(</span><span class="s1">&#39;bad_response&#39;</span><span class="p">);</span>
        <span class="p">},</span>
      <span class="p">}]);</span>

      <span class="nx">convo</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>

      <span class="nx">convo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">convo</span><span class="p">.</span><span class="nx">successful</span><span class="p">())</span> <span class="p">{</span>
          <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;Let us eat some!&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></code></pre></div></p>

<h1 id="마무리">마무리</h1>

<p>원래 봇을 통해 의도했던 ChatOps는 아직 시작하지 못했지만, 회사 행정에 도움 되는 기능부터 하나씩 스킬을 늘려가고 있습니다.
다음번에는 <a href="https://api.slack.com/messaging/interactivity">인터랙티브 메시지</a>를 만드는 방법을 소개하도록 하겠습니다.</p>

        </div>
      </div>
      
      <div class='panel panel-default'>
        <div class='panel-heading'>
          <h2 class='posts-title'><a href='/ko/tech/2018-05-30-1-croquis-stack-rest-api/'>크로키의 스택 - REST API</a></h2>
          <p class='posts-date'>30 May 2018</p>
        </div>
        <div class='panel-body'>
          

<p>크로키가 클라이언트-서버 아키텍처를 가진 첫 번째 서비스 개발을 시작한 것은 2012년이었습니다.
클라이언트에서 서버와 통신할 방법이 필요했는데 당시의 대세는 REST API였습니다.
저도 거기에 공감했기 때문에 REST API를 만들어 클라이언트를 구현했습니다.
그 후로 모든 서비스는 기본적으로 REST API로 클라이언트와 서버가 통신하고 있습니다.</p>

<p>다만 여기서 말하는 REST API는 REST API라는 것에 대한 일반적인 인식 - 리소스 URI 명명법 및 HTTP 상태 코드 - 을
따른 API를 말하는 것으로, <a href="https://en.wikipedia.org/wiki/Roy_Fielding">Roy Fielding</a>이
얘기하는 <a href="https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm">REST 아키텍처</a>와는 거리가 있습니다.
Stateless 조건을 만족하는 대신 쿠키를 사용하고 있고,
<a href="https://en.wikipedia.org/wiki/HATEOAS">HATEOAS</a>는 지금도 어떻게 사용하면 좋을지 감을 잡지 못하고 있습니다.
Accept 헤더도 인식하지 않고 무조건 JSON을 가정하고 있습니다.</p>

<p>지금도 REST 스타일로 리소스 URI를 명명하는 것은 옳다고 생각하고, 웹 서비스의 각 페이지 주소는 최대한 REST 스타일로 이름 짓고 있습니다.
다만 API를 REST API로 하는 것이 맞는지는 계속 의문을 품고 있습니다.
다음은 수년간 서비스를 개발하면서 REST API 스타일이 적합하지 않는다고 생각한 예를 적어보겠습니다.</p>

<h3 id="http-동사로-처리하기-어려운-api">HTTP 동사로 처리하기 어려운 API</h3>

<p>가장 처음에 맞닥뜨린 고민은 로그인, 로그아웃 API였습니다.
HTTP 동사에 딱 맞지 않는 경우 적당한 리소스 뒤에 동사를 붙이는 것으로 처리하는 경우를 많이 봤습니다.
예를 들어 로그인은 <code>/users/me/login</code>과 같이 처리하는 것이죠.
그런데 저는 동사를 피해야 한다고 하면서 마지막에 동사가 있는 것이 맘에 들지 않았습니다.</p>

<p>로그인/로그아웃의 경우 세션이라는 리소스를 다루는 것으로 간주하는 <a href="https://stackoverflow.com/a/7252311">API 디자인</a>도 봤습니다.
<code>로그인 = POST /sessions</code>, <code>로그아웃 = DELETE /sessions</code>와 같이 대응시키는 것입니다.
하지만 너무 어색하게 느껴졌고, 이런 식으로 처리하기 어려운 예도 많았습니다.</p>

<p>그래서 이런 경우는 REST API가 아닌 API를 만들고 문서도 다르게 기술했습니다.</p>

<ul>
<li>REST API: <code>GET /users</code>, <code>POST /events</code></li>
<li>non-REST API: <code>/login (POST)</code></li>
</ul>

<p>다음은 non-REST API로 만들었던 API들의 예입니다.</p>

<ul>
<li>로그인: <code>/login</code></li>
<li>사용자 A가 B에게 팀에 가입 요청(join_request)을 한 후 B가 해당 요청을 승인/거절: <code>/acceptJoinRequest</code>, <code>/ignoreJoinRequest</code></li>
<li>특정 경기에 참여: <code>/joinMatch</code></li>
<li>서비스 계정과 페이스북 계정의 연결/연결 끊기: <code>/linkWithFacebook</code>, <code>/unlinkWithFacebook</code></li>
</ul>

<h3 id="여러-리소스를-한-번에-가져오기">여러 리소스를 한 번에 가져오기</h3>

<p>몇 개의 리소스에서 데이터를 한 번에 가져오고 싶은 경우에 API를 정의하기 어려웠습니다.</p>

<p>예를 들어 지그재그에서 사용자가 담아둔 상품의 가격을 갱신하기 위해서 서버에 데이터를 요청하는데 REST API로는 기술하기가 어려웠습니다.
굳이 하자면 <code>GET /products/1,6,29,35/price</code> 같은 형태를 생각해볼 수 있지만, 상품이 많은 경우 URL 길이의 제한에 걸릴 수 있습니다.</p>

<p>결국, 이런 경우 RPC 스타일로 API를 정의했습니다. <code>/getProductPrices</code></p>

<h3 id="요청자마다-원하는-데이터가-다른-경우">요청자마다 원하는 데이터가 다른 경우</h3>

<p>같은 리소스지만 모든 데이터가 필요하지 않은 경우 네트워크 사용량을 줄이기 위해 특정 필드만 반환하도록 fields 인자를 지정하는 REST API를 종종 보셨을 것입니다.</p>

<p>저의 경우 네트워크 사용량은 무시해서 fields 인자를 사용하지는 않았지만, 일부 필드는 추가적인 DB 접근이 필요한 경우가 있어서 필요한 경우만 요청하도록 하는 규칙을 정했었습니다.
예를 들어 이벤트 정보를 받을 때 이벤트가 열리는 장소와 참석자는 별도 테이블(Place, EventAttendance)에 있다 보니 다음과 같이 요청했습니다.</p>

<p><code>GET /events/123?add=attendances,place</code></p>

<h3 id="같은-리소스지만-인자에-따라-처리-코드가-다른-경우">같은 리소스지만 인자에 따라 처리 코드가 다른 경우</h3>

<p>비슷한 상품 목록이지만 검색어 검색과 카테고리 검색의 코드가 다릅니다.
그런데 라우트는 <code>GET /products</code> 하나로 구성해야 합니다.
이런 경우가 있을 때마다 제대로 URL을 정한 것인지 고민이 됩니다.</p>

<p>특히 인자에 따라 결괏값이 달라야 하는 경우 같은 리소스가 맞나 싶을 때가 있습니다.</p>

<h3 id="결정하기-어려운-이름">결정하기 어려운 이름</h3>

<p>보통 리소스 목록은 <code>/resources</code>, 개별 리소스는 <code>/resources/:id</code>로 구성을 하지만,
가끔 리소스 목록에 후자를 쓰고 싶을 때가 있습니다.
상태(<code>/resources/valid</code>)나 검색(<code>/resources/my-query</code>) 같은 경우인데요,
페이지 URL이 REST 형태로 잘 구성되어 있다고 생각하는 GitHub에서도
<a href="https://github.com/nodejs/node/pulls/10000">https://github.com/nodejs/node/pulls/10000</a> 같은 주소를 보면 쉽지 않다고 느낍니다.</p>

<h1 id="결론">결론</h1>

<p>현재 크로키닷컴의 API는 REST API가 기본이지만 위에 적힌 이유로 마이크로서비스 간의 통신에는 Thrift를 사용해서 RPC 스타일의 API를 사용해 보고 있습니다.
또한, 최근에는 클라이언트-서버 간의 API도 통일하기 위해서 GrpahQL을 시도해보고 있습니다.
이에 대해서는 추후 다른 포스팅으로 설명하겠습니다.</p>

        </div>
      </div>
      
    </div>

    
<div class='col-xs-12 text-center'>
  
  <ul class='pagination'>
    
    <li><a href='/ko/tech/'>&laquo; 처음</a></li>
    <li><a href='/ko/tech/'>&lt; 이전</a></li>
    

    

    
    
    
    
    <li><a href='/ko/tech/'>1</a></li>
    
    
    
    
    
    <li class='active'><span>2</span></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/3/'>3</a></li>
    
    
    
    
    
    <li><a href='/ko/tech/page/4/'>4</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    <li class='disabled'><span>&hellip;</span></li>
    

    
    <li><a href='/ko/tech/page/3/'>다음 &gt;</a></li>
    <li><a href='/ko/tech/page/11/'>끝 &raquo;</a></li>
    
  </ul>
  
</div>

  </div>

</div>

<div class='container-fluid'>
  <hr>
  <footer>
    <p>
      &copy; 2014-2019 Sangmin Yoon
      <span class='pull-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        ,
        <a href='http://getbootstrap.com/' target='_blank'>Bootstrap</a>
        ,
        <a href='http://www.dnsever.com' target='dnsever'><img src='http://banner.dnsever.com/dnsever-banner_62x15.gif'
            border='0' alt='DNS server, DNS service '></a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48366784-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

<script src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>

</body>

</html>